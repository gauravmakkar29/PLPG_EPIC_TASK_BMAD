<<<<<<< HEAD
// =============================================================================
// PLPG Prisma Schema
// =============================================================================
// Database schema for the Personalized Learning Path Generator (PLPG)
// This schema defines all entities for the ML learning platform.
//
// @module @plpg/shared/prisma
// @description Complete database schema matching architecture.md
// =============================================================================

generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// USER MANAGEMENT
// =============================================================================

/// User role enumeration for access control
enum UserRole {
  free
  pro
  admin
}

/// Core user entity representing a registered PLPG user
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String?
  avatarUrl     String?   @map("avatar_url")
  role          UserRole  @default(free)
  emailVerified Boolean   @default(false) @map("email_verified")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  onboarding    OnboardingResponse?
  roadmap       Roadmap?
  subscription  Subscription?
  feedback      Feedback[]
  refreshTokens RefreshToken[]
  checkIns      CheckIn[]

  @@index([email])
  @@map("users")
}

/// Refresh token for JWT authentication
model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

/// User's onboarding responses for roadmap generation
model OnboardingResponse {
  id           String    @id @default(uuid())
  userId       String    @unique @map("user_id")
  currentRole  String    @map("current_role")
  targetRole   String    @default("ml_engineer") @map("target_role")
  weeklyHours  Int       @map("weekly_hours")
  skillsToSkip String[]  @default([]) @map("skills_to_skip")
  completedAt  DateTime? @map("completed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("onboarding_responses")
}

// =============================================================================
// SKILL & CONTENT MANAGEMENT
// =============================================================================

/// Learning phase enumeration for skill categorization
enum Phase {
  foundation
  core_ml
  deep_learning
}

/// Skill entity representing a learnable topic in the DAG
model Skill {
  id             String  @id @default(uuid())
  name           String
  slug           String  @unique
  description    String
  phase          Phase
  estimatedHours Decimal @map("estimated_hours") @db.Decimal(4, 1)
  isOptional     Boolean @default(false) @map("is_optional")
  sequenceOrder  Int     @default(0) @map("sequence_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  resources     Resource[]
  prerequisites SkillPrerequisite[] @relation("SkillPrereqs")
  dependents    SkillPrerequisite[] @relation("SkillDependents")
  modules       RoadmapModule[]

  @@index([phase])
  @@index([slug])
  @@map("skills")
}

/// DAG edge representing skill dependency relationship
model SkillPrerequisite {
  id             String @id @default(uuid())
  skillId        String @map("skill_id")
  prerequisiteId String @map("prerequisite_id")

  skill        Skill @relation("SkillPrereqs", fields: [skillId], references: [id], onDelete: Cascade)
  prerequisite Skill @relation("SkillDependents", fields: [prerequisiteId], references: [id], onDelete: Cascade)

  @@unique([skillId, prerequisiteId])
  @@map("skill_prerequisites")
}

/// Resource type enumeration for learning materials
enum ResourceType {
  video
  documentation
  tutorial
  mini_project
}

/// Learning resource associated with a skill
model Resource {
  id               String       @id @default(uuid())
  skillId          String       @map("skill_id")
  title            String
  url              String
  type             ResourceType
  source           String
  estimatedMinutes Int          @map("estimated_minutes")
  description      String?
  qualityScore     Decimal?     @map("quality_score") @db.Decimal(2, 1)
  isRecommended    Boolean      @default(false) @map("is_recommended")
  isFree           Boolean      @default(true) @map("is_free")
  verifiedAt       DateTime?    @map("verified_at")
  sequenceOrder    Int          @default(0) @map("sequence_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@index([skillId])
  @@map("resources")
}

// =============================================================================
// ROADMAP & PROGRESS
// =============================================================================

/// User's personalized learning roadmap
model Roadmap {
  id                  String   @id @default(uuid())
  userId              String   @unique @map("user_id")
  weeklyHours         Int      @map("weekly_hours")
  totalHours          Decimal  @map("total_hours") @db.Decimal(6, 1)
  completedHours      Decimal  @default(0) @map("completed_hours") @db.Decimal(6, 1)
  projectedCompletion DateTime @map("projected_completion")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  modules RoadmapModule[]

  @@map("roadmaps")
}

/// Module status enumeration for learning progress
enum ModuleStatus {
  locked
  available
  in_progress
  completed
  skipped
}

/// Individual module in a user's roadmap
model RoadmapModule {
  id            String       @id @default(uuid())
  roadmapId     String       @map("roadmap_id")
  skillId       String       @map("skill_id")
  phase         Phase
  sequenceOrder Int          @map("sequence_order")
  status        ModuleStatus @default(locked)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  roadmap  Roadmap    @relation(fields: [roadmapId], references: [id], onDelete: Cascade)
  skill    Skill      @relation(fields: [skillId], references: [id])
  progress Progress?
  feedback Feedback[]

  @@unique([roadmapId, skillId])
  @@index([roadmapId])
  @@index([status])
  @@map("roadmap_modules")
}

/// Progress tracking for a roadmap module
model Progress {
  id               String    @id @default(uuid())
  moduleId         String    @unique @map("module_id")
  startedAt        DateTime? @map("started_at")
  completedAt      DateTime? @map("completed_at")
  timeSpentMinutes Int       @default(0) @map("time_spent_minutes")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  module RoadmapModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@map("progress")
}

// =============================================================================
// SUBSCRIPTION
// =============================================================================

/// Subscription status enumeration
enum SubscriptionStatus {
  active
  expired
  cancelled
}

/// User subscription for premium features
model Subscription {
  id        String             @id @default(uuid())
  userId    String             @unique @map("user_id")
  plan      String             @default("free")
  status    SubscriptionStatus @default(active)
  expiresAt DateTime?          @map("expires_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// =============================================================================
// ENGAGEMENT
// =============================================================================

/// User feedback on completed modules
model Feedback {
  id       String  @id @default(uuid())
  userId   String  @map("user_id")
  moduleId String  @map("module_id")
  rating   Int
  comment  String?

  createdAt DateTime @default(now()) @map("created_at")

  user   User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  module RoadmapModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@index([moduleId])
  @@index([userId])
  @@map("feedback")
}

/// Check-in type enumeration for engagement tracking
enum CheckInType {
  daily
  weekly
  milestone
}

/// User check-in for streak tracking
model CheckIn {
  id          String      @id @default(uuid())
  userId      String      @map("user_id")
  type        CheckInType @default(daily)
  checkedInAt DateTime    @default(now()) @map("checked_in_at")
  metadata    Json?

  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([checkedInAt])
  @@map("check_ins")
}
=======
// =============================================================================
// PLPG Prisma Schema
// =============================================================================
// Database schema for the Personalized Learning Path Generator (PLPG)
// This schema defines all entities for the ML learning platform.
//
// @module @plpg/shared/prisma
// @description Complete database schema matching architecture.md
// =============================================================================

generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// USER MANAGEMENT
// =============================================================================

/// User role enumeration for access control
enum UserRole {
  free
  pro
  admin
}

/// Core user entity representing a registered PLPG user
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String?
  avatarUrl     String?   @map("avatar_url")
  role          UserRole  @default(free)
  emailVerified Boolean   @default(false) @map("email_verified")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  onboarding          OnboardingResponse?
  roadmap             Roadmap?
  subscription        Subscription?
  feedback            Feedback[]
  refreshTokens       RefreshToken[]
  checkIns            CheckIn[]
  passwordResetTokens PasswordResetToken[]

  @@index([email])
  @@map("users")
}

/// Refresh token for JWT authentication
model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

/// Password reset token for forgot password flow
model PasswordResetToken {
  id        String   @id @default(uuid())
  tokenHash String   @unique @map("token_hash")
  userId    String   @map("user_id")
  email     String
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([email])
  @@map("password_reset_tokens")
}

/// User's onboarding responses for roadmap generation
model OnboardingResponse {
  id           String    @id @default(uuid())
  userId       String    @unique @map("user_id")
  currentRole  String    @map("current_role")
  targetRole   String    @default("ml_engineer") @map("target_role")
  weeklyHours  Int       @map("weekly_hours")
  skillsToSkip String[]  @default([]) @map("skills_to_skip")
  completedAt  DateTime? @map("completed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("onboarding_responses")
}

// =============================================================================
// SKILL & CONTENT MANAGEMENT
// =============================================================================

/// Learning phase enumeration for skill categorization
enum Phase {
  foundation
  core_ml
  deep_learning
}

/// Skill entity representing a learnable topic in the DAG
model Skill {
  id             String  @id @default(uuid())
  name           String
  slug           String  @unique
  description    String
  phase          Phase
  estimatedHours Decimal @map("estimated_hours") @db.Decimal(4, 1)
  isOptional     Boolean @default(false) @map("is_optional")
  sequenceOrder  Int     @default(0) @map("sequence_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  resources     Resource[]
  prerequisites SkillPrerequisite[] @relation("SkillPrereqs")
  dependents    SkillPrerequisite[] @relation("SkillDependents")
  modules       RoadmapModule[]

  @@index([phase])
  @@index([slug])
  @@map("skills")
}

/// DAG edge representing skill dependency relationship
model SkillPrerequisite {
  id             String @id @default(uuid())
  skillId        String @map("skill_id")
  prerequisiteId String @map("prerequisite_id")

  skill        Skill @relation("SkillPrereqs", fields: [skillId], references: [id], onDelete: Cascade)
  prerequisite Skill @relation("SkillDependents", fields: [prerequisiteId], references: [id], onDelete: Cascade)

  @@unique([skillId, prerequisiteId])
  @@map("skill_prerequisites")
}

/// Resource type enumeration for learning materials
enum ResourceType {
  video
  documentation
  tutorial
  mini_project
}

/// Learning resource associated with a skill
model Resource {
  id               String       @id @default(uuid())
  skillId          String       @map("skill_id")
  title            String
  url              String
  type             ResourceType
  source           String
  estimatedMinutes Int          @map("estimated_minutes")
  description      String?
  qualityScore     Decimal?     @map("quality_score") @db.Decimal(2, 1)
  isRecommended    Boolean      @default(false) @map("is_recommended")
  isFree           Boolean      @default(true) @map("is_free")
  verifiedAt       DateTime?    @map("verified_at")
  sequenceOrder    Int          @default(0) @map("sequence_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@index([skillId])
  @@map("resources")
}

// =============================================================================
// ROADMAP & PROGRESS
// =============================================================================

/// User's personalized learning roadmap
model Roadmap {
  id                  String   @id @default(uuid())
  userId              String   @unique @map("user_id")
  weeklyHours         Int      @map("weekly_hours")
  totalHours          Decimal  @map("total_hours") @db.Decimal(6, 1)
  completedHours      Decimal  @default(0) @map("completed_hours") @db.Decimal(6, 1)
  projectedCompletion DateTime @map("projected_completion")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  modules RoadmapModule[]

  @@map("roadmaps")
}

/// Module status enumeration for learning progress
enum ModuleStatus {
  locked
  available
  in_progress
  completed
  skipped
}

/// Individual module in a user's roadmap
model RoadmapModule {
  id            String       @id @default(uuid())
  roadmapId     String       @map("roadmap_id")
  skillId       String       @map("skill_id")
  phase         Phase
  sequenceOrder Int          @map("sequence_order")
  status        ModuleStatus @default(locked)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  roadmap  Roadmap    @relation(fields: [roadmapId], references: [id], onDelete: Cascade)
  skill    Skill      @relation(fields: [skillId], references: [id])
  progress Progress?
  feedback Feedback[]

  @@unique([roadmapId, skillId])
  @@index([roadmapId])
  @@index([status])
  @@map("roadmap_modules")
}

/// Progress tracking for a roadmap module
model Progress {
  id               String    @id @default(uuid())
  moduleId         String    @unique @map("module_id")
  startedAt        DateTime? @map("started_at")
  completedAt      DateTime? @map("completed_at")
  timeSpentMinutes Int       @default(0) @map("time_spent_minutes")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  module RoadmapModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@map("progress")
}

// =============================================================================
// SUBSCRIPTION
// =============================================================================

/// Subscription status enumeration
enum SubscriptionStatus {
  active
  expired
  cancelled
}

/// User subscription for premium features
model Subscription {
  id        String             @id @default(uuid())
  userId    String             @unique @map("user_id")
  plan      String             @default("free")
  status    SubscriptionStatus @default(active)
  expiresAt DateTime?          @map("expires_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// =============================================================================
// ENGAGEMENT
// =============================================================================

/// User feedback on completed modules
model Feedback {
  id       String  @id @default(uuid())
  userId   String  @map("user_id")
  moduleId String  @map("module_id")
  rating   Int
  comment  String?

  createdAt DateTime @default(now()) @map("created_at")

  user   User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  module RoadmapModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@index([moduleId])
  @@index([userId])
  @@map("feedback")
}

/// Check-in type enumeration for engagement tracking
enum CheckInType {
  daily
  weekly
  milestone
}

/// User check-in for streak tracking
model CheckIn {
  id          String      @id @default(uuid())
  userId      String      @map("user_id")
  type        CheckInType @default(daily)
  checkedInAt DateTime    @default(now()) @map("checked_in_at")
  metadata    Json?

  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([checkedInAt])
  @@map("check_ins")
}
>>>>>>> 9b1b27416ae3d64842f1de66868c739e58c1de04
