# Story 0.6: Backend App Scaffold (apps/api)

## Status
Draft

## Parent Epic
[Epic 0: Technical Foundation](../epic-0-technical-foundation.md)

## Story
**As a** backend developer,
**I want** a configured Express + TypeScript application,
**So that** I can start building API endpoints immediately

## Acceptance Criteria
1. Express.js + TypeScript configured
2. Layer architecture: controllers → services → repositories
3. Prisma client imported from @plpg/shared
4. Middleware pipeline configured
5. Error handling middleware
6. Health check endpoint working
7. ESLint + Prettier working

## Tasks / Subtasks
- [ ] Create Express app scaffold (AC: 1)
  - [ ] Initialize package.json for apps/api
  - [ ] Install Express, TypeScript, tsx
  - [ ] Create app.ts and server.ts entry points
- [ ] Configure TypeScript (AC: 1)
  - [ ] Create tsconfig.json extending @plpg/config
  - [ ] Configure path aliases
- [ ] Set up layer architecture (AC: 2)
  - [ ] Create controllers/ directory with health.controller.ts
  - [ ] Create services/ directory with .gitkeep
  - [ ] Create repositories/ directory with .gitkeep
  - [ ] Create routes/ directory with index.ts and health.routes.ts
- [ ] Configure Prisma client import (AC: 3)
  - [ ] Create lib/prisma.ts to import from @plpg/shared
  - [ ] Export singleton instance
- [ ] Set up middleware pipeline (AC: 4)
  - [ ] Create middleware/logger.middleware.ts with Pino
  - [ ] Create middleware/rateLimiter.middleware.ts
  - [ ] Create middleware/validate.middleware.ts for Zod
  - [ ] Configure helmet and CORS
- [ ] Create error handling middleware (AC: 5)
  - [ ] Create middleware/errorHandler.middleware.ts
  - [ ] Handle AppError types from @plpg/shared
- [ ] Create health check endpoint (AC: 6)
  - [ ] Implement GET /v1/health route
  - [ ] Return status and timestamp
- [ ] Configure linting (AC: 7)
  - [ ] Create .eslintrc.cjs extending @plpg/config

## Dev Notes

### Directory Structure
```
apps/api/
├── src/
│   ├── controllers/
│   │   └── health.controller.ts
│   ├── services/
│   │   └── .gitkeep
│   ├── repositories/
│   │   └── .gitkeep
│   ├── middleware/
│   │   ├── auth.middleware.ts      # JWT validation middleware
│   │   ├── errorHandler.middleware.ts
│   │   ├── rateLimiter.middleware.ts
│   │   ├── validate.middleware.ts  # Zod validation
│   │   └── logger.middleware.ts
│   ├── routes/
│   │   ├── index.ts
│   │   └── health.routes.ts
│   ├── lib/
│   │   ├── prisma.ts               # Prisma client instance
│   │   ├── logger.ts               # Pino logger
│   │   └── env.ts                  # Environment validation
│   ├── types/
│   │   └── express.d.ts            # Express augmentation
│   ├── app.ts
│   └── server.ts
├── tsconfig.json                   # Extends @plpg/config/typescript/node
├── .eslintrc.cjs                   # Extends @plpg/config/eslint/node
└── package.json
```

### Express App Setup
```typescript
import express from 'express';
import cors from 'cors';
import helmet from 'helmet';
import { errorHandler } from './middleware/errorHandler.middleware';
import { requestLogger } from './middleware/logger.middleware';
import { rateLimiter } from './middleware/rateLimiter.middleware';
import routes from './routes';

const app = express();

app.use(helmet());
app.use(cors({
  origin: process.env.FRONTEND_URL || 'http://localhost:5173',
  credentials: true,
}));
app.use(express.json({ limit: '10kb' }));
app.use(requestLogger);
app.use(rateLimiter);
app.use('/v1', routes);
app.use(errorHandler);

export default app;
```

### Testing
- **Test file location**: `apps/api/src/**/*.test.ts`
- **Test standards**: Unit tests for services, integration tests for routes
- **Testing frameworks**: Vitest + Supertest
- **Mocking**: vitest-mock-extended for Prisma

## Definition of Done
- [ ] `npm run dev` starts Express server on localhost:3001
- [ ] Layer architecture directories created
- [ ] Prisma client importable from @plpg/shared
- [ ] Middleware pipeline configured (helmet, CORS, logger, rate limiter)
- [ ] Error handler catches and formats errors
- [ ] GET /v1/health returns 200 with status
- [ ] ESLint and Prettier pass

## Unit Test Cases
- Test health endpoint returns 200 with correct format
- Test error handler formats AppError correctly
- Test error handler returns 500 for unknown errors
- Test rate limiter blocks excessive requests
- Test CORS allows frontend origin
- Test logger middleware logs requests

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 0.1 | Initial story creation | SM Agent |
