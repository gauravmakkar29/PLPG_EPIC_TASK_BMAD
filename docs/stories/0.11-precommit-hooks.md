# Story 0.11: Pre-commit Hooks (Husky + lint-staged)

## Status
Draft

## Parent Epic
[Epic 0: Technical Foundation](../epic-0-technical-foundation.md)

## Story
**As a** developer,
**I want** pre-commit hooks to catch issues early,
**So that** CI doesn't fail on trivial errors

## Acceptance Criteria
1. Husky installed and configured
2. lint-staged runs on staged files only
3. Pre-commit: lint + typecheck staged files
4. Pre-push: run tests (optional, can be slow)
5. Commit message linting (Conventional Commits)

## Tasks / Subtasks
- [ ] Install and configure Husky (AC: 1)
  - [ ] Install husky as dev dependency
  - [ ] Add `prepare` script to package.json
  - [ ] Run `npm run prepare` to initialize .husky directory
- [ ] Configure lint-staged (AC: 2, 3)
  - [ ] Install lint-staged as dev dependency
  - [ ] Add lint-staged configuration to package.json
  - [ ] Configure for TypeScript/TSX files (eslint --fix, prettier --write)
  - [ ] Configure for JSON/MD/YAML files (prettier --write)
- [ ] Create pre-commit hook (AC: 3)
  - [ ] Create `.husky/pre-commit` script
  - [ ] Run `npx lint-staged`
- [ ] Install and configure commitlint (AC: 5)
  - [ ] Install @commitlint/cli and @commitlint/config-conventional
  - [ ] Create `commitlint.config.js`
  - [ ] Define type-enum (feat, fix, docs, style, refactor, test, chore, perf)
  - [ ] Define scope-enum (web, api, shared, config, ui, engine, infra, deps)
- [ ] Create commit-msg hook (AC: 5)
  - [ ] Create `.husky/commit-msg` script
  - [ ] Run `npx commitlint --edit $1`
- [ ] Document commit message format (AC: 5)
  - [ ] Add CONTRIBUTING.md with commit guidelines

## Dev Notes

### Package.json Configuration
```json
{
  "scripts": {
    "prepare": "husky install"
  },
  "lint-staged": {
    "*.{ts,tsx}": [
      "eslint --fix",
      "prettier --write"
    ],
    "*.{json,md,yaml,yml}": [
      "prettier --write"
    ]
  }
}
```

### Pre-commit Hook
```bash
# .husky/pre-commit
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

npx lint-staged
```

### Commit-msg Hook
```bash
# .husky/commit-msg
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

npx commitlint --edit $1
```

### Commitlint Config
```javascript
// commitlint.config.js
module.exports = {
  extends: ['@commitlint/config-conventional'],
  rules: {
    'type-enum': [
      2,
      'always',
      ['feat', 'fix', 'docs', 'style', 'refactor', 'test', 'chore', 'perf'],
    ],
    'scope-enum': [
      2,
      'always',
      ['web', 'api', 'shared', 'config', 'ui', 'engine', 'infra', 'deps'],
    ],
  },
};
```

### Commit Message Format
```
<type>(<scope>): <subject>

[optional body]

[optional footer]
```

Examples:
- `feat(web): add login form component`
- `fix(api): handle null user in auth middleware`
- `docs(shared): update type documentation`

### Testing
- **Test file location**: N/A (configuration)
- **Test standards**: Verify hooks trigger correctly
- **Verification**: Attempt bad commit to verify rejection

## Definition of Done
- [ ] Husky installed and .husky directory created
- [ ] lint-staged configured in package.json
- [ ] Pre-commit hook runs lint-staged on staged files
- [ ] Commitlint installed and configured
- [ ] Commit-msg hook validates commit messages
- [ ] Bad commits are rejected with helpful message
- [ ] CONTRIBUTING.md documents commit format

## Unit Test Cases
- Test pre-commit hook blocks files with lint errors
- Test pre-commit hook fixes auto-fixable issues
- Test commit-msg rejects non-conventional commits
- Test commit-msg accepts valid conventional commits
- Test lint-staged only processes staged files

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 0.1 | Initial story creation | SM Agent |
