# Story 0.4: Database Package with Prisma (@plpg/shared/prisma)

## Status
Draft

## Parent Epic
[Epic 0: Technical Foundation](../epic-0-technical-foundation.md)

## Story
**As a** developer,
**I want** a centralized Prisma schema and client,
**So that** database access is consistent across the backend

## Acceptance Criteria
1. Prisma schema defined with all entities
2. Generated Prisma client exportable
3. Migration scripts configured
4. Seed script for development data
5. Database URL configurable via environment

## Tasks / Subtasks
- [ ] Add Prisma to `packages/shared` (AC: 1, 2)
  - [ ] Install Prisma and @prisma/client
  - [ ] Initialize Prisma with PostgreSQL provider
- [ ] Create complete schema from architecture (AC: 1)
  - [ ] Define User model with all fields
  - [ ] Define RefreshToken model
  - [ ] Define OnboardingResponse model
  - [ ] Define Skill model with Phase enum
  - [ ] Define SkillPrerequisite model for DAG
  - [ ] Define Resource model with ResourceType enum
  - [ ] Define Roadmap model
  - [ ] Define RoadmapModule model with ModuleStatus enum
  - [ ] Define Progress model
  - [ ] Define Subscription model with SubscriptionStatus enum
  - [ ] Define Feedback model
  - [ ] Add all indexes and relations
- [ ] Configure Prisma client generation (AC: 2)
  - [ ] Set up generator configuration
  - [ ] Export Prisma client from package
- [ ] Create seed script with sample data (AC: 4)
  - [ ] Create test users
  - [ ] Create skills for Backend Dev → ML Engineer path
  - [ ] Create skill prerequisites (DAG structure)
  - [ ] Create sample resources
- [ ] Configure migration workflow (AC: 3, 5)
  - [ ] Add db:migrate script
  - [ ] Add db:push script for development
  - [ ] Add db:seed script
  - [ ] Add db:studio script

## Dev Notes

### Prisma Schema Location
`packages/shared/prisma/schema.prisma`

### Key Enums
```prisma
enum UserRole { free, pro, admin }
enum Phase { foundation, core_ml, deep_learning }
enum ResourceType { video, documentation, tutorial, mini_project }
enum ModuleStatus { locked, available, in_progress, completed, skipped }
enum SubscriptionStatus { active, expired, cancelled }
```

### Package Scripts
```json
{
  "scripts": {
    "db:generate": "prisma generate",
    "db:migrate": "prisma migrate dev",
    "db:migrate:prod": "prisma migrate deploy",
    "db:push": "prisma db push",
    "db:seed": "tsx prisma/seed.ts",
    "db:studio": "prisma studio"
  }
}
```

### Database URL
```
DATABASE_URL=postgresql://plpg:plpg_local_password@localhost:5432/plpg_dev
```

### Testing
- **Test file location**: `packages/shared/prisma/__tests__/`
- **Test standards**: Integration tests with test database
- **Testing frameworks**: Vitest with test database
- **Test database**: Use `TEST_DATABASE_URL` environment variable

## Definition of Done
- [ ] Prisma schema includes all entities from architecture.md
- [ ] `prisma generate` creates client successfully
- [ ] `prisma migrate dev` creates initial migration
- [ ] Seed script populates development data
- [ ] DATABASE_URL is configurable via environment
- [ ] Prisma client exportable and usable from apps/api

## Unit Test Cases
- Test Prisma client connects to database
- Test User model CRUD operations
- Test Skill model with prerequisites relationship
- Test Roadmap → RoadmapModule → Progress cascading relations
- Test seed script creates expected data

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 0.1 | Initial story creation | SM Agent |
