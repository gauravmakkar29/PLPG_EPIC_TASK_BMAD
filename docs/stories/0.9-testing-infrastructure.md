# Story 0.9: Testing Infrastructure Setup

## Status
Draft

## Parent Epic
[Epic 0: Technical Foundation](../epic-0-technical-foundation.md)

## Story
**As a** developer,
**I want** a complete testing setup,
**So that** I can write tests from day one

## Acceptance Criteria
1. Vitest configured for all packages
2. Test patterns documented
3. Database mocking strategy defined
4. API mocking with MSW configured
5. Test utilities created (React render wrapper, DB seeder)
6. Example tests for each layer

## Tasks / Subtasks
- [ ] Configure Vitest workspace at root (AC: 1)
  - [ ] Create `vitest.workspace.ts` at root
  - [ ] Define workspace for apps/web, apps/api, packages/shared
- [ ] Set up frontend test environment (AC: 1, 5)
  - [ ] Create `apps/web/vitest.config.ts` with jsdom
  - [ ] Create `apps/web/src/test/setup.ts` for global setup
  - [ ] Create `apps/web/src/test/utils.tsx` with custom render
  - [ ] Configure coverage with v8 provider
- [ ] Create React test utilities (AC: 5)
  - [ ] Create AllProviders wrapper with QueryClient, Router, Auth
  - [ ] Create customRender function
  - [ ] Export testing-library utilities
- [ ] Set up backend test environment (AC: 1)
  - [ ] Create `apps/api/vitest.config.ts`
  - [ ] Create `apps/api/src/test/setup.ts`
  - [ ] Configure coverage
- [ ] Create Prisma mock utilities (AC: 3, 5)
  - [ ] Install vitest-mock-extended
  - [ ] Create `apps/api/src/test/db.ts` with mock utilities
  - [ ] Create createMockPrisma function
  - [ ] Create createTestPrisma for integration tests
  - [ ] Create seedTestData function
- [ ] Configure MSW for API mocking (AC: 4)
  - [ ] Install msw
  - [ ] Create `apps/web/src/test/mocks/handlers.ts`
  - [ ] Create `apps/web/src/test/mocks/server.ts`
  - [ ] Add auth mock handlers
  - [ ] Add roadmap mock handlers
- [ ] Write example tests (AC: 6)
  - [ ] Create example component test in apps/web
  - [ ] Create example service test in apps/api
  - [ ] Create example schema test in packages/shared
- [ ] Document test patterns (AC: 2)
  - [ ] Add testing section to README
  - [ ] Document file naming conventions
  - [ ] Document mocking strategies

## Dev Notes

### Vitest Workspace
```typescript
// vitest.workspace.ts (root)
import { defineWorkspace } from 'vitest/config';

export default defineWorkspace([
  'apps/web/vitest.config.ts',
  'apps/api/vitest.config.ts',
  'packages/shared/vitest.config.ts',
  'packages/roadmap-engine/vitest.config.ts',
]);
```

### React Test Setup
```typescript
// apps/web/src/test/setup.ts
import '@testing-library/jest-dom';
import { beforeAll, afterAll, afterEach } from 'vitest';
import { server } from './mocks/server';

beforeAll(() => server.listen({ onUnhandledRequest: 'error' }));
afterEach(() => server.resetHandlers());
afterAll(() => server.close());
```

### Custom Render
```typescript
// apps/web/src/test/utils.tsx
function AllProviders({ children }) {
  const queryClient = createTestQueryClient();
  return (
    <AuthProvider>
      <QueryClientProvider client={queryClient}>
        <MemoryRouter>{children}</MemoryRouter>
      </QueryClientProvider>
    </AuthProvider>
  );
}

export function customRender(ui, options) {
  return render(ui, { wrapper: AllProviders, ...options });
}
```

### Test Directory Pattern
```
apps/web/src/
├── components/
│   ├── Button/
│   │   ├── Button.tsx
│   │   ├── Button.test.tsx      # Co-located test
│   │   └── index.ts
├── test/
│   ├── mocks/
│   │   ├── handlers.ts
│   │   └── server.ts
│   ├── setup.ts
│   └── utils.tsx
```

### Testing
- **Coverage target**: >70% for critical paths
- **Test standards**: Co-locate tests with source files
- **Naming convention**: `*.test.ts` or `*.test.tsx`

## Definition of Done
- [ ] Vitest workspace configured at root
- [ ] Frontend tests run with jsdom environment
- [ ] Backend tests run with node environment
- [ ] MSW configured for API mocking
- [ ] Prisma mock utilities created
- [ ] React test utilities with providers created
- [ ] Example tests pass in all packages
- [ ] `npm test` runs all workspace tests

## Unit Test Cases
- Test customRender provides all required providers
- Test MSW handlers intercept API calls correctly
- Test createMockPrisma returns properly typed mock
- Test seedTestData creates expected database records

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 0.1 | Initial story creation | SM Agent |
