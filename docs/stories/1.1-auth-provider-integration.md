# Story 1.1: Auth Provider Integration

## Status
Draft

## Parent Epic
[Epic 1: User Authentication & Profile](../epic-1-authentication.md)

## Story
**As a** user visiting the application,
**I want** authentication UI to be available,
**So that** I can sign up or log in

## Acceptance Criteria
1. AuthProvider wraps the application in `apps/web/src/App.tsx`
2. Auth context provides user state, login, logout, register functions
3. Token stored securely in localStorage
4. Redirect URLs configured for post-auth navigation
5. Loading state shown while checking auth status

## Tasks / Subtasks
- [ ] Create AuthContext and AuthProvider (AC: 1, 2)
  - [ ] Create `apps/web/src/context/AuthContext.tsx`
  - [ ] Define User interface with id, email, name, subscriptionStatus, trialEndsAt
  - [ ] Define AuthContextType with user, isLoading, isAuthenticated, login, register, logout
  - [ ] Implement useAuth hook
- [ ] Implement authentication state management (AC: 2, 3)
  - [ ] Create checkAuth function to validate existing token
  - [ ] Implement login function with API call and token storage
  - [ ] Implement register function with API call and token storage
  - [ ] Implement logout function to clear token and state
- [ ] Integrate AuthProvider in App.tsx (AC: 1)
  - [ ] Wrap application with AuthProvider
  - [ ] Ensure proper provider hierarchy (Auth > Query > Router)
- [ ] Handle loading states (AC: 5)
  - [ ] Show loading spinner during auth check
  - [ ] Prevent flash of unauthenticated content
- [ ] Configure redirect URLs (AC: 4)
  - [ ] Redirect to /onboarding after registration
  - [ ] Redirect to /dashboard after login

## Dev Notes

### AuthContext Implementation
```typescript
// apps/web/src/context/AuthContext.tsx
interface User {
  id: string;
  email: string;
  name: string | null;
  subscriptionStatus: 'free' | 'trial' | 'pro';
  trialEndsAt: string | null;
}

interface AuthContextType {
  user: User | null;
  isLoading: boolean;
  isAuthenticated: boolean;
  login: (email: string, password: string) => Promise<void>;
  register: (email: string, password: string, name?: string) => Promise<void>;
  logout: () => void;
}
```

### Token Storage
- Store JWT in localStorage under key `auth_token`
- Token automatically included in API requests via axios interceptor (from E0)

### Dependencies from E0
- API service layer from `apps/web/src/services/api.ts`
- QueryClient configuration from `apps/web/src/lib/queryClient.ts`

### Testing
- **Test file location**: `apps/web/src/context/AuthContext.test.tsx`
- **Test standards**: Component tests with Testing Library
- **Testing frameworks**: Vitest + @testing-library/react
- **Mocking**: Mock API calls with MSW

## Definition of Done
- [ ] AuthProvider wraps entire application
- [ ] useAuth hook returns correct user state
- [ ] Login function stores token and updates state
- [ ] Register function stores token and updates state
- [ ] Logout clears token and state
- [ ] Loading state prevents content flash
- [ ] Unit tests pass with >80% coverage

## Unit Test Cases
- Test AuthProvider renders children
- Test useAuth throws error when used outside provider
- Test login stores token in localStorage
- Test login updates user state
- Test register stores token in localStorage
- Test logout clears localStorage
- Test logout resets user to null
- Test isLoading is true during auth check
- Test isAuthenticated reflects user presence

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 0.1 | Initial story creation | SM Agent |
