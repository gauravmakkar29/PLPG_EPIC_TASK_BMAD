# Story 0.8: API Contract Definition

## Status
Draft

## Parent Epic
[Epic 0: Technical Foundation](../epic-0-technical-foundation.md)

## Story
**As a** developer (frontend or backend),
**I want** a documented API contract,
**So that** teams can work in parallel against the same specification

## Acceptance Criteria
1. Auth endpoints documented with request/response types
2. OpenAPI specification file created
3. Zod schemas match OpenAPI spec
4. Example requests included

## Tasks / Subtasks
- [ ] Create OpenAPI specification document (AC: 2)
  - [ ] Create `docs/api-spec.yaml` file
  - [ ] Define OpenAPI 3.0.3 structure
  - [ ] Add info section with API title and version
- [ ] Document Auth endpoints (AC: 1, 4)
  - [ ] POST /v1/auth/register - RegisterInput → AuthResponse
  - [ ] POST /v1/auth/login - LoginInput → AuthResponse
  - [ ] POST /v1/auth/logout - void → { success: true }
  - [ ] POST /v1/auth/forgot-password - { email } → { success: true }
  - [ ] POST /v1/auth/reset-password - ResetPasswordInput → { success: true }
  - [ ] GET /v1/auth/me - void → Session
  - [ ] POST /v1/auth/refresh - { refreshToken } → { token }
- [ ] Define component schemas (AC: 2, 3)
  - [ ] Session schema
  - [ ] AuthResponse schema
  - [ ] Error response schema
- [ ] Define security schemes (AC: 2)
  - [ ] bearerAuth for JWT tokens
- [ ] Ensure Zod schemas match OpenAPI (AC: 3)
  - [ ] Verify registerSchema matches spec
  - [ ] Verify loginSchema matches spec
  - [ ] Add comments linking schemas to OpenAPI

## Dev Notes

### Auth API Contract

| Method | Endpoint | Request | Response | Auth |
|--------|----------|---------|----------|------|
| POST | `/v1/auth/register` | `RegisterInput` | `AuthResponse` | None |
| POST | `/v1/auth/login` | `LoginInput` | `AuthResponse` | None |
| POST | `/v1/auth/logout` | - | `{ success: true }` | Required |
| POST | `/v1/auth/forgot-password` | `{ email }` | `{ success: true }` | None |
| POST | `/v1/auth/reset-password` | `ResetPasswordInput` | `{ success: true }` | None |
| GET | `/v1/auth/me` | - | `Session` | Required |
| POST | `/v1/auth/refresh` | `{ refreshToken }` | `{ token }` | None |

### OpenAPI Snippet
```yaml
openapi: 3.0.3
info:
  title: PLPG API
  version: 1.0.0
paths:
  /v1/auth/me:
    get:
      summary: Get current session
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Session'
        '401':
          $ref: '#/components/responses/Unauthorized'
components:
  schemas:
    Session:
      type: object
      properties:
        userId:
          type: string
        email:
          type: string
        name:
          type: string
          nullable: true
        subscriptionStatus:
          type: string
          enum: [free, trial, pro]
        trialEndsAt:
          type: string
          format: date-time
          nullable: true
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
```

### Testing
- **Test file location**: N/A (documentation)
- **Test standards**: Validate OpenAPI spec with online validator
- **Verification**: Use swagger-cli to validate yaml

## Definition of Done
- [ ] `docs/api-spec.yaml` created with valid OpenAPI 3.0.3 structure
- [ ] All auth endpoints documented with request/response schemas
- [ ] Example requests included for each endpoint
- [ ] Zod schemas in @plpg/shared match OpenAPI schemas
- [ ] OpenAPI spec passes validation

## Unit Test Cases
- Validate OpenAPI spec syntax is correct
- Test Zod registerSchema matches OpenAPI RegisterInput
- Test Zod loginSchema matches OpenAPI LoginInput
- Test response types match OpenAPI definitions

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 0.1 | Initial story creation | SM Agent |
