# Story 0.7: Authentication Middleware (The Gatekeeper)

## Status
Draft

## Parent Epic
[Epic 0: Technical Foundation](../epic-0-technical-foundation.md)

## Story
**As a** developer building protected features,
**I want** reusable auth middleware,
**So that** I can protect routes consistently

## Acceptance Criteria
1. `requireAuth` middleware validates JWT tokens
2. `requireSubscription` middleware checks plan status
3. User object attached to request
4. Middleware exported from a single location
5. TypeScript types for augmented Request

## Tasks / Subtasks
- [ ] Implement `jwtMiddleware` (AC: 1, 3)
  - [ ] Parse Bearer token from Authorization header
  - [ ] Verify JWT using jsonwebtoken
  - [ ] Fetch user from database
  - [ ] Attach user object to req.user
  - [ ] Continue without user if no token (optional auth)
- [ ] Implement `requireAuth` middleware (AC: 1)
  - [ ] Check if req.user exists
  - [ ] Return 401 UnauthorizedError if not
- [ ] Implement `requirePro` middleware (AC: 2)
  - [ ] Check subscription status on req.user
  - [ ] Return 403 ForbiddenError if not Pro/Trial
- [ ] Implement `requirePhaseAccess` middleware (AC: 2)
  - [ ] Accept phase number parameter
  - [ ] Check subscription for phase access
  - [ ] Phase 1 accessible to trial users
  - [ ] Phase 2+ requires Pro subscription
- [ ] Create TypeScript augmentation (AC: 5)
  - [ ] Augment Express.Request with user property
  - [ ] Define user interface with id, email, subscriptionStatus
- [ ] Export from single location (AC: 4)
  - [ ] Create middleware/index.ts barrel file
  - [ ] Export all middleware functions

## Dev Notes

### Middleware Implementation
```typescript
// apps/api/src/middleware/auth.middleware.ts
import { Request, Response, NextFunction } from 'express';
import jwt from 'jsonwebtoken';
import { prisma } from '../lib/prisma';
import { ForbiddenError, UnauthorizedError } from '@plpg/shared/errors';

declare global {
  namespace Express {
    interface Request {
      user?: {
        id: string;
        email: string;
        subscriptionStatus: 'free' | 'trial' | 'pro';
        trialEndsAt: Date | null;
      };
    }
  }
}

export const jwtMiddleware = async (req, res, next) => {
  // Parse and verify JWT, attach user to request
};

export const requireAuth = async (req, res, next) => {
  if (!req.user) {
    return next(new UnauthorizedError());
  }
  next();
};

export const requirePro = async (req, res, next) => {
  if (req.user?.subscriptionStatus === 'free') {
    return next(new ForbiddenError('Pro subscription required'));
  }
  next();
};
```

### Export Index
```typescript
// apps/api/src/middleware/index.ts
export { requireAuth, requirePro, requirePhaseAccess } from './auth.middleware';
export { errorHandler } from './errorHandler.middleware';
export { validate } from './validate.middleware';
export { rateLimiter } from './rateLimiter.middleware';
```

### Testing
- **Test file location**: `apps/api/src/middleware/auth.middleware.test.ts`
- **Test standards**: Unit tests with mocked dependencies
- **Testing frameworks**: Vitest + vitest-mock-extended
- **Mocking**: Mock Prisma client and JWT verify

## Definition of Done
- [ ] jwtMiddleware parses and verifies JWT tokens
- [ ] requireAuth rejects requests without valid user
- [ ] requirePro checks subscription status correctly
- [ ] requirePhaseAccess gates content by phase
- [ ] User object properly typed on req.user
- [ ] All middleware exported from index.ts
- [ ] JSDoc documentation added

## Unit Test Cases
- Test jwtMiddleware attaches user when token valid
- Test jwtMiddleware continues without user when no token
- Test jwtMiddleware continues without user when token invalid
- Test requireAuth returns 401 when no user
- Test requireAuth calls next when user exists
- Test requirePro returns 403 when status is 'free'
- Test requirePro allows 'pro' and 'trial' users
- Test requirePhaseAccess allows trial for Phase 1
- Test requirePhaseAccess blocks free for Phase 2+

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 0.1 | Initial story creation | SM Agent |
