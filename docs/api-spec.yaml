# =============================================================================
# PLPG API OpenAPI Specification
# =============================================================================
# Personalized Learning Path Generator (PLPG) API Contract
# This specification defines all API endpoints for the PLPG platform.
#
# @version 1.0.0
# @license MIT
# =============================================================================

openapi: 3.0.3

info:
  title: PLPG API
  description: |
    # Personalized Learning Path Generator API

    REST API for the PLPG platform - a personalized ML learning path generator.

    ## Authentication

    Most endpoints require JWT authentication. Include the access token in the
    Authorization header:

    ```
    Authorization: Bearer <access_token>
    ```

    ## Rate Limiting

    - General endpoints: 100 requests per minute
    - Auth endpoints: 5 requests per 15 minutes

    ## Error Handling

    All errors follow a consistent format with error codes for client handling.
  version: 1.0.0
  contact:
    name: PLPG API Support
    email: support@plpg.dev
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3001/api/v1
    description: Local development server
  - url: https://api.plpg.dev/api/v1
    description: Production server

tags:
  - name: Authentication
    description: User authentication and session management
  - name: Health
    description: API health check endpoints

# =============================================================================
# PATHS
# =============================================================================

paths:
  # ---------------------------------------------------------------------------
  # Authentication Endpoints
  # ---------------------------------------------------------------------------

  /auth/register:
    post:
      tags:
        - Authentication
      summary: Register a new user
      security: []
      description: |
        Creates a new user account with email, password, and name.

        **Password Requirements:**
        - Minimum 8 characters
        - At least one uppercase letter
        - At least one lowercase letter
        - At least one number
        - At least one special character

        After registration, a verification email is sent to the provided address.
      operationId: registerUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
            examples:
              basic:
                summary: Basic registration
                value:
                  email: user@example.com
                  password: SecureP@ss123
                  name: John Doe
      responses:
        '201':
          description: User successfully registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
              examples:
                success:
                  summary: Successful registration
                  value:
                    user:
                      id: 550e8400-e29b-41d4-a716-446655440000
                      email: user@example.com
                      name: John Doe
                      avatarUrl: null
                      role: free
                      isVerified: false
                      createdAt: '2026-01-08T12:00:00.000Z'
                    accessToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                    refreshToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidEmail:
                  summary: Invalid email format
                  value:
                    error:
                      code: VALIDATION_ERROR
                      message: Invalid request data
                      status: 400
                      details:
                        email: Invalid email address
                weakPassword:
                  summary: Weak password
                  value:
                    error:
                      code: VALIDATION_ERROR
                      message: Invalid request data
                      status: 400
                      details:
                        password: Password must contain at least one uppercase letter
        '409':
          description: Email already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                conflict:
                  summary: Email already exists
                  value:
                    error:
                      code: CONFLICT
                      message: Email already registered
                      status: 409
        '429':
          $ref: '#/components/responses/RateLimitExceeded'

  /auth/login:
    post:
      tags:
        - Authentication
      summary: Login with email and password
      security: []
      description: |
        Authenticates a user with email and password credentials.
        Returns access and refresh tokens on successful authentication.

        Access tokens expire after 15 minutes.
        Refresh tokens expire after 7 days.
      operationId: loginUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            examples:
              basic:
                summary: Basic login
                value:
                  email: user@example.com
                  password: SecureP@ss123
      responses:
        '200':
          description: Successfully authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
              examples:
                success:
                  summary: Successful login
                  value:
                    user:
                      id: 550e8400-e29b-41d4-a716-446655440000
                      email: user@example.com
                      name: John Doe
                      avatarUrl: null
                      role: free
                      isVerified: true
                      createdAt: '2026-01-08T12:00:00.000Z'
                    accessToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                    refreshToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missingFields:
                  summary: Missing required fields
                  value:
                    error:
                      code: VALIDATION_ERROR
                      message: Invalid request data
                      status: 400
                      details:
                        password: Password is required
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidCredentials:
                  summary: Wrong email or password
                  value:
                    error:
                      code: UNAUTHORIZED
                      message: Invalid email or password
                      status: 401
        '429':
          $ref: '#/components/responses/RateLimitExceeded'

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout current user
      description: |
        Invalidates the current refresh token, effectively logging out the user.
        The access token will remain valid until it expires (15 minutes).

        For immediate session termination, clients should discard the access token locally.
      operationId: logoutUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Successfully logged out
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              examples:
                success:
                  summary: Successful logout
                  value:
                    success: true
                    message: Successfully logged out
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/forgot-password:
    post:
      tags:
        - Authentication
      summary: Request password reset
      security: []
      description: |
        Initiates the password reset flow by sending a reset link to the user's email.

        **Security Notes:**
        - Always returns success to prevent email enumeration
        - Reset tokens expire after 1 hour
        - Only one active reset token per user
      operationId: forgotPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ForgotPasswordRequest'
            examples:
              basic:
                summary: Request password reset
                value:
                  email: user@example.com
      responses:
        '200':
          description: Password reset email sent (if account exists)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              examples:
                success:
                  summary: Reset email sent
                  value:
                    success: true
                    message: If an account exists with this email, a password reset link has been sent
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidEmail:
                  summary: Invalid email format
                  value:
                    error:
                      code: VALIDATION_ERROR
                      message: Invalid request data
                      status: 400
                      details:
                        email: Invalid email address
        '429':
          $ref: '#/components/responses/RateLimitExceeded'

  /auth/reset-password:
    post:
      tags:
        - Authentication
      summary: Reset password with token
      security: []
      description: |
        Completes the password reset flow using the token from the reset email.

        **Password Requirements:**
        - Minimum 8 characters
        - At least one uppercase letter
        - At least one lowercase letter
        - At least one number
        - At least one special character
      operationId: resetPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPasswordRequest'
            examples:
              basic:
                summary: Reset password
                value:
                  token: abc123def456...
                  password: NewSecureP@ss456
      responses:
        '200':
          description: Password successfully reset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              examples:
                success:
                  summary: Password reset successful
                  value:
                    success: true
                    message: Password has been reset successfully
        '400':
          description: Validation error or invalid/expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidToken:
                  summary: Invalid or expired token
                  value:
                    error:
                      code: BAD_REQUEST
                      message: Invalid or expired reset token
                      status: 400
                weakPassword:
                  summary: Weak password
                  value:
                    error:
                      code: VALIDATION_ERROR
                      message: Invalid request data
                      status: 400
                      details:
                        password: Password must be at least 8 characters
        '429':
          $ref: '#/components/responses/RateLimitExceeded'

  /auth/me:
    get:
      tags:
        - Authentication
      summary: Get current session
      description: |
        Returns the current authenticated user's session information.
        Useful for checking authentication status and getting user details.
      operationId: getCurrentSession
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current session information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionInfo'
              examples:
                success:
                  summary: Session info
                  value:
                    user:
                      id: 550e8400-e29b-41d4-a716-446655440000
                      email: user@example.com
                      name: John Doe
                      avatarUrl: null
                      role: free
                      isVerified: true
                      createdAt: '2026-01-08T12:00:00.000Z'
                    expiresAt: '2026-01-08T12:15:00.000Z'
                    issuedAt: '2026-01-08T12:00:00.000Z'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      security: []
      description: |
        Exchanges a valid refresh token for a new access token.
        Optionally returns a new refresh token (token rotation).

        **Token Rotation:**
        For enhanced security, refresh tokens may be rotated on each use.
        Always store and use the latest refresh token returned.
      operationId: refreshToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshTokenRequest'
            examples:
              basic:
                summary: Refresh tokens
                value:
                  refreshToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        '200':
          description: New tokens issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RefreshTokenResponse'
              examples:
                withRotation:
                  summary: With token rotation
                  value:
                    accessToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                    refreshToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                withoutRotation:
                  summary: Without token rotation
                  value:
                    accessToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missingToken:
                  summary: Missing refresh token
                  value:
                    error:
                      code: VALIDATION_ERROR
                      message: Invalid request data
                      status: 400
                      details:
                        refreshToken: Refresh token is required
        '401':
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidToken:
                  summary: Invalid refresh token
                  value:
                    error:
                      code: UNAUTHORIZED
                      message: Invalid or expired refresh token
                      status: 401

  # ---------------------------------------------------------------------------
  # Health Check Endpoints
  # ---------------------------------------------------------------------------

  /health:
    get:
      tags:
        - Health
      summary: Basic health check
      security: []
      description: Returns basic API health status
      operationId: healthCheck
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              examples:
                healthy:
                  summary: Healthy response
                  value:
                    status: ok
                    timestamp: '2026-01-08T12:00:00.000Z'
                    version: 0.1.0
        '503':
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unavailable:
                  summary: Service unavailable
                  value:
                    error:
                      code: SERVICE_UNAVAILABLE
                      message: Service temporarily unavailable
                      status: 503

# =============================================================================
# COMPONENTS
# =============================================================================

components:
  # ---------------------------------------------------------------------------
  # Security Schemes
  # ---------------------------------------------------------------------------

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT access token. Obtain via `/auth/login` or `/auth/register`.

        **Token Lifetime:** 15 minutes

        Include in requests as:
        ```
        Authorization: Bearer <token>
        ```

  # ---------------------------------------------------------------------------
  # Schemas
  # ---------------------------------------------------------------------------

  schemas:
    # -------------------------------------------------------------------------
    # Auth Request Schemas
    # -------------------------------------------------------------------------

    RegisterRequest:
      type: object
      description: Registration request body
      required:
        - email
        - password
        - name
      properties:
        email:
          type: string
          format: email
          minLength: 5
          maxLength: 255
          description: User's email address (will be normalized to lowercase)
          example: user@example.com
        password:
          type: string
          format: password
          minLength: 8
          maxLength: 128
          description: |
            User's password. Must contain:
            - At least one uppercase letter
            - At least one lowercase letter
            - At least one number
            - At least one special character
          example: SecureP@ss123
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: User's display name
          example: John Doe

    LoginRequest:
      type: object
      description: Login request body
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          minLength: 5
          maxLength: 255
          description: User's email address
          example: user@example.com
        password:
          type: string
          format: password
          minLength: 1
          description: User's password
          example: SecureP@ss123

    ForgotPasswordRequest:
      type: object
      description: Forgot password request body
      required:
        - email
      properties:
        email:
          type: string
          format: email
          minLength: 5
          maxLength: 255
          description: Email address associated with the account
          example: user@example.com

    ResetPasswordRequest:
      type: object
      description: Reset password request body
      required:
        - token
        - password
      properties:
        token:
          type: string
          minLength: 1
          description: Password reset token from email
          example: abc123def456ghi789
        password:
          type: string
          format: password
          minLength: 8
          maxLength: 128
          description: New password (same requirements as registration)
          example: NewSecureP@ss456

    RefreshTokenRequest:
      type: object
      description: Token refresh request body
      required:
        - refreshToken
      properties:
        refreshToken:
          type: string
          minLength: 1
          description: Valid refresh token
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

    # -------------------------------------------------------------------------
    # Auth Response Schemas
    # -------------------------------------------------------------------------

    AuthResponse:
      type: object
      description: Authentication response with user and tokens
      required:
        - user
        - accessToken
        - refreshToken
      properties:
        user:
          $ref: '#/components/schemas/AuthUser'
        accessToken:
          type: string
          description: JWT access token (expires in 15 minutes)
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        refreshToken:
          type: string
          description: JWT refresh token (expires in 7 days)
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

    RefreshTokenResponse:
      type: object
      description: Token refresh response
      required:
        - accessToken
      properties:
        accessToken:
          type: string
          description: New JWT access token
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        refreshToken:
          type: string
          description: New refresh token (if rotation is enabled)
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

    SessionInfo:
      type: object
      description: Current session information
      required:
        - user
        - expiresAt
        - issuedAt
      properties:
        user:
          $ref: '#/components/schemas/AuthUser'
        expiresAt:
          type: string
          format: date-time
          description: When the current access token expires
          example: '2026-01-08T12:15:00.000Z'
        issuedAt:
          type: string
          format: date-time
          description: When the current access token was issued
          example: '2026-01-08T12:00:00.000Z'

    # -------------------------------------------------------------------------
    # User Schemas
    # -------------------------------------------------------------------------

    AuthUser:
      type: object
      description: User information returned in auth responses
      required:
        - id
        - email
        - role
        - isVerified
        - createdAt
      properties:
        id:
          type: string
          format: uuid
          description: User's unique identifier
          example: 550e8400-e29b-41d4-a716-446655440000
        email:
          type: string
          format: email
          description: User's email address
          example: user@example.com
        name:
          type: string
          nullable: true
          description: User's display name
          example: John Doe
        avatarUrl:
          type: string
          format: uri
          nullable: true
          description: URL to user's avatar image
          example: https://example.com/avatars/user.jpg
        role:
          $ref: '#/components/schemas/UserRole'
        isVerified:
          type: boolean
          description: Whether the user's email is verified
          example: true
        createdAt:
          type: string
          format: date-time
          description: Account creation timestamp
          example: '2026-01-08T12:00:00.000Z'

    UserRole:
      type: string
      description: User access role
      enum:
        - free
        - pro
        - admin
      example: free

    # -------------------------------------------------------------------------
    # Common Response Schemas
    # -------------------------------------------------------------------------

    SuccessResponse:
      type: object
      description: Generic success response
      required:
        - success
      properties:
        success:
          type: boolean
          description: Operation success status
          example: true
        message:
          type: string
          description: Human-readable success message
          example: Operation completed successfully

    HealthResponse:
      type: object
      description: Health check response
      required:
        - status
        - timestamp
        - version
      properties:
        status:
          type: string
          enum:
            - ok
            - degraded
            - error
          description: API health status
          example: ok
        timestamp:
          type: string
          format: date-time
          description: Current server timestamp
          example: '2026-01-08T12:00:00.000Z'
        version:
          type: string
          description: API version
          example: 0.1.0

    # -------------------------------------------------------------------------
    # Error Schemas
    # -------------------------------------------------------------------------

    ErrorResponse:
      type: object
      description: Standard error response format
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
            - status
          properties:
            code:
              $ref: '#/components/schemas/ErrorCode'
            message:
              type: string
              description: Human-readable error message
              example: Invalid request data
            status:
              type: integer
              description: HTTP status code
              example: 400
            details:
              type: object
              additionalProperties: true
              description: Additional error details (e.g., validation errors)
              example:
                email: Invalid email address

    ErrorCode:
      type: string
      description: Application error codes for client handling
      enum:
        - VALIDATION_ERROR
        - UNAUTHORIZED
        - FORBIDDEN
        - NOT_FOUND
        - CONFLICT
        - RATE_LIMITED
        - INTERNAL_ERROR
        - BAD_REQUEST
        - SERVICE_UNAVAILABLE
      example: VALIDATION_ERROR

  # ---------------------------------------------------------------------------
  # Reusable Responses
  # ---------------------------------------------------------------------------

  responses:
    Unauthorized:
      description: Authentication required or invalid token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            unauthorized:
              summary: Authentication required
              value:
                error:
                  code: UNAUTHORIZED
                  message: Authentication required
                  status: 401

    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            forbidden:
              summary: Access denied
              value:
                error:
                  code: FORBIDDEN
                  message: Access denied
                  status: 403

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            notFound:
              summary: Resource not found
              value:
                error:
                  code: NOT_FOUND
                  message: Resource not found
                  status: 404

    RateLimitExceeded:
      description: Rate limit exceeded
      headers:
        Retry-After:
          description: Seconds until rate limit resets
          schema:
            type: integer
            example: 900
        X-RateLimit-Limit:
          description: Request limit per window
          schema:
            type: integer
            example: 5
        X-RateLimit-Remaining:
          description: Remaining requests in window
          schema:
            type: integer
            example: 0
        X-RateLimit-Reset:
          description: Unix timestamp when window resets
          schema:
            type: integer
            example: 1704715200
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            rateLimited:
              summary: Too many requests
              value:
                error:
                  code: RATE_LIMITED
                  message: Too many requests
                  status: 429
                  details:
                    retryAfter: 900
